<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StayFinder | Student Homes in Patna</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main class="shell">
        <section class="dashboard discover-no-map">
            <aside class="sidebar">
                <div class="brand">
                    <span class="brand-mark">S</span>
                    <span class="brand-text">StayFinder</span>
                </div>

                <nav class="menu">
                    <a href="hmbutton.html" class="menu-item">
                        <span>Home</span>
                    </a>
                    <a href="message.html" class="menu-item">
                        <span>Messages</span>
                    </a>
                    <a href="index.html" class="menu-item active">
                        <span>Discover</span>
                    </a>
                    <a href="favorites.html" class="menu-item">
                        <span>Favorites</span>
                    </a>
                    <a href="setting.html" class="menu-item">
                        <span>Settings</span>
                    </a>
                </nav>

                <div class="cta-card">
                    <h3>Find student-friendly homes</h3>
                    <p>Affordable and simple rentals near coaching areas.</p>
                    <button>Search</button>
                </div>
            </aside>

            <section class="content">
                <div class="content-top">
                    <div class="breadcrumbs">Discover <span>/</span> Student homes in Patna</div>
                    <div class="user">Ashish Mishra</div>
                </div>

                <div class="discover-head">
                    <div class="discover-count" id="discover-count">Loading properties...</div>
                    <div class="discover-sort">
                        <label for="sort-by">Sort by:</label>
                        <select id="sort-by">
                            <option>Relevance</option>
                            <option>Price: Low to High</option>
                            <option>Price: High to Low</option>
                            <option>Newest</option>
                        </select>
                    </div>
                </div>

                <h1 class="discover-title">1 BHK & 2 BHK Flats for Rent in Patna</h1>

                <div class="property-list" id="property-list"></div>
            </section>

        </section>
    </main>

    <div class="contact-modal-backdrop" id="contact-modal-backdrop" hidden></div>
    <section class="contact-modal" id="contact-modal" role="dialog" aria-modal="true" aria-labelledby="contact-modal-title" hidden>
        <button class="contact-modal-close" id="contact-modal-close" type="button" aria-label="Close contact form">x</button>
        <div class="contact-modal-alert">
            <span aria-hidden="true">&#9889;</span>
            <p>Great choice! Better priced property in this area</p>
        </div>
        <h2 class="contact-modal-title" id="contact-modal-title">Contact Seller</h2>
        <div class="contact-seller-card">
            <div class="contact-seller-avatar" aria-hidden="true">A</div>
            <div>
                <strong>Maa Real Estate</strong>
                <p>Housing Prime Agent</p>
                <a href="tel:+917640000000">+917640....</a>
            </div>
        </div>
        <p class="contact-caption">Please share your contact</p>
        <form class="contact-form" id="contact-form">
            <label class="contact-field">
                <span>Name</span>
                <input id="contact-name" type="text" placeholder="Name" required>
            </label>
            <label class="contact-field">
                <span>Phone</span>
                <div class="phone-field">
                    <span>+91</span>
                    <input id="contact-phone" type="tel" placeholder="Phone" required>
                </div>
            </label>
            <label class="contact-consent">
                <input type="checkbox" checked required>
                <span>I agree to be contacted by Housing and agents via WhatsApp, SMS, phone, email etc</span>
            </label>
            <button class="contact-submit" type="submit">Get Contact Details</button>
        </form>
    </section>

    <script src="auth-client.js"></script>
    <script>
        const API_BASE = "http://localhost:5000/api";
        const propertyList = document.getElementById("property-list");
        const discoverCount = document.getElementById("discover-count");
        const sortBy = document.getElementById("sort-by");
        const contactModal = document.getElementById("contact-modal");
        const contactBackdrop = document.getElementById("contact-modal-backdrop");
        const contactCloseButton = document.getElementById("contact-modal-close");
        const contactForm = document.getElementById("contact-form");
        const contactNameInput = document.getElementById("contact-name");
        const contactPhoneInput = document.getElementById("contact-phone");

        let properties = [];
        let activePropertyId = "";
        const userBadge = document.querySelector(".user");

        async function refreshUserBadge() {
            if (!window.StayAuth || !StayAuth.getToken()) {
                userBadge.innerHTML = "<a href=\"login.html\">Login</a>";
                return;
            }

            try {
                const profile = await StayAuth.getMe(API_BASE);
                userBadge.innerHTML = "<a href=\"profile.html\">" + profile.user.name + "</a>";
            } catch (error) {
                StayAuth.clearToken();
                userBadge.innerHTML = "<a href=\"login.html\">Login</a>";
            }
        }

        function formatPrice(price) {
            return "Rs " + Number(price).toLocaleString("en-IN");
        }

        function getSortedProperties(list, sortValue) {
            const sorted = list.slice();
            if (sortValue === "Price: Low to High") {
                sorted.sort(function (a, b) { return a.price - b.price; });
            } else if (sortValue === "Price: High to Low") {
                sorted.sort(function (a, b) { return b.price - a.price; });
            }
            return sorted;
        }

        function renderProperties() {
            const sorted = getSortedProperties(properties, sortBy.value);

            if (!sorted.length) {
                propertyList.innerHTML = "<p class=\"property-updated\">No properties found.</p>";
                discoverCount.textContent = "Showing 0 properties";
                return;
            }

            propertyList.innerHTML = sorted.map(function (property) {
                return `
                    <article class="property-card" data-property-id="${property.id}">
                        <img src="${property.image || "https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?auto=format&fit=crop&w=900&q=80"}" alt="${property.title}">
                        <div class="property-info">
                            <h3>${property.title}</h3>
                            <p class="property-location">${property.location}</p>
                            <div class="property-meta">
                                <strong>${formatPrice(property.price)}</strong>
                                <span>${property.areaSqft} sq.ft builtup area</span>
                                <span>${property.furnishing}</span>
                            </div>
                            <p class="property-highlights">Highlights: ${property.highlights || "Student friendly locality"}</p>
                            <p class="property-updated">${property.updatedAt || "Recently updated"}</p>
                        </div>
                        <div class="actions">
                            <button class="contact-btn" type="button" data-property-id="${property.id}">Contact</button>
                            <button class="ghost save-btn" type="button" data-property-id="${property.id}">Save</button>
                        </div>
                    </article>
                `;
            }).join("");

            discoverCount.textContent = "Showing 1 - " + sorted.length + " of " + sorted.length + " properties";
        }

        async function loadProperties() {
            try {
                const response = await fetch(API_BASE + "/properties");
                if (!response.ok) {
                    throw new Error("Failed to load properties");
                }
                const payload = await response.json();
                properties = payload.data || [];
                renderProperties();
            } catch (error) {
                propertyList.innerHTML = "<p class=\"property-updated\">Backend not running. Start Node.js API on port 5000.</p>";
                discoverCount.textContent = "Unable to load properties";
            }
        }

        function openContactModal() {
            contactModal.hidden = false;
            contactBackdrop.hidden = false;
            document.body.classList.add("modal-open");
        }

        function closeContactModal() {
            contactModal.hidden = true;
            contactBackdrop.hidden = true;
            document.body.classList.remove("modal-open");
            activePropertyId = "";
            contactForm.reset();
        }

        propertyList.addEventListener("click", async function (event) {
            const target = event.target;
            if (!(target instanceof HTMLElement)) {
                return;
            }

            if (target.classList.contains("contact-btn")) {
                activePropertyId = target.dataset.propertyId || "";
                openContactModal();
                return;
            }

            if (target.classList.contains("save-btn")) {
                const propertyId = target.dataset.propertyId;
                if (!propertyId) {
                    return;
                }
                try {
                    const token = StayAuth.getToken();
                    if (!token) {
                        StayAuth.redirectToLogin("index.html");
                        return;
                    }
                    const response = await StayAuth.fetchWithAuth(API_BASE + "/favorites", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ propertyId: propertyId })
                    });
                    if (!response.ok) {
                        throw new Error("Failed to save favorite");
                    }
                    alert("Saved to favorites.");
                } catch (error) {
                    alert("Could not save favorite. Please check backend.");
                }
            }
        });

        contactCloseButton.addEventListener("click", closeContactModal);
        contactBackdrop.addEventListener("click", closeContactModal);

        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape" && !contactModal.hidden) {
                closeContactModal();
            }
        });

        contactForm.addEventListener("submit", function (event) {
            event.preventDefault();
            if (!activePropertyId) {
                alert("Please choose a property first.");
                return;
            }

            const payload = {
                name: contactNameInput.value.trim(),
                phone: "+91" + contactPhoneInput.value.trim(),
                propertyId: activePropertyId
            };

            fetch(API_BASE + "/contact-request", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(function (response) {
                if (!response.ok) {
                    throw new Error("Request failed");
                }
                closeContactModal();
                alert("Contact request submitted.");
            }).catch(function () {
                alert("Could not submit contact request. Please check backend.");
            });
        });

        sortBy.addEventListener("change", renderProperties);
        loadProperties();
        refreshUserBadge();

    </script>
</body>
</html>
